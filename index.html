<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>

<body>

<h1 id="heading">JSON to CSV converter</h1>

<div class="center-container">
    <form method="post" enctype="multipart/form-data">
        <label class="custom-uploader" for="file">Upload Your File</label> 
        <input id="Jsonfile" accept=".json" name="fileToUpload" type="file" />
    </form>
    <div class="btnContain"> 
        <button class="uploadBtn" id="upload" style="display:inline-block;"> Upload File </button>
    </div>
    <div class="btnContain"> 
        <button id="download" class="downBtn" style="display:none;">Download CSV</button>
    </div>
</div>


</body>
<script>

function flattenValues(obj, prefix = '') {
    let flattened = [];
    for (const key in obj) {
        if (typeof obj[key] === "object" && obj[key] !== null && !Array.isArray(obj[key])) { //for keys containing objects only
            const temp = flattenValues(obj[key], `${prefix}${key}_`);
            flattened.push(...temp);
        } 
        else if (Array.isArray(obj[key])) { // for keys containing arrays
            obj[key].forEach((item, index) => {
                if(typeof item === 'object' && item !== null){ // for nested array with objects
                    const temp = flattenValues(item, `${prefix}${key}`);
                    flattened.push(...temp);
                }
                else { // for single dimension arrays
                    flattened.push({ key: `${prefix}${key}`, value: obj[key][index] });
                }
            });
        } else { 
            flattened.push({ key: `${prefix}${key}`, value: obj[key] });
        }
    }
    return flattened;
}

function convertCSV(input) {
    const keyVal = {};

    // create an array for the keys and push associated values to the array
    input.forEach(item => {
        if (!keyVal[item.key]) {
            keyVal[item.key] = [];
        }
        keyVal[item.key].push(item.value);
    });
    console.log(keyVal);

    let csvContent = '';
    const headers = Object.keys(keyVal).join(',') + '\r\n';
    csvContent += headers;

    // Creating a row for each value, if key does not have any more values, replaced by ""
    const valuesArray = Object.values(keyVal);
    const maxLength = valuesArray.reduce((max, arr) => Math.max(max, arr.length), 0);

    for (let i = 0; i < maxLength; i++) {
        let row = '';
        Object.keys(keyVal).forEach(key => {
            const value = (keyVal[key][i] !== undefined ? keyVal[key][i] : ''); // checks if value is defined, else ""
            row += `"${value}",`;
        });
        // Added to csv, removing ','
        csvContent += row.slice(0, -1) + '\r\n';
    }
    csvContent = csvContent.replace(/\r\n$/, '');

    return csvContent;
}

function downloadCSV(csvContent){
    const blob = new Blob([csvContent], { type: 'application/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.download = 'output.csv';
    a.href = url;
    a.style.display = 'none';

    document.body.appendChild(a);

    a.click();

    a.remove();

    URL.revokeObjectURL(url);
}


document.getElementById('upload').addEventListener('click', (event) => {
    event.preventDefault();
    // Get the file input element
    const fileInput = document.getElementById('Jsonfile');
    // Ensure a file was selected
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        
        // Read the file
        const reader = new FileReader();
        reader.onload = function (event) {
            // Parse the JSON content
            try {
                const jsonData = JSON.parse(event.target.result);
                console.log(jsonData);
                const flatten = flattenValues(jsonData); // parse makes the json file to be contained as an obj, calls only the json file data
                console.log(flatten);
                const csvContent = convertCSV(flatten);
                var download = document.getElementById('download').style.display = "inline-block";
                var upload = document.getElementById('upload').style.display = "none";
                document.getElementById('download').addEventListener('click', () => {
                    console.log(csvContent);
                    downloadCSV(csvContent);
                })
                return csvContent;
            } catch (e) {
                console.error('Error parsing JSON', e);
            }
        };
        reader.onerror = function (error) {
            console.error('Error reading file', error);
        };
        reader.readAsText(file);
    } else {
        console.error('No file selected.');
    }
});
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

</html>